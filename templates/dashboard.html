<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç AI Application Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #eee;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #00d9ff33;
        }
        
        .header h1 {
            font-size: 2em;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="text"] {
            padding: 10px 15px;
            border: 1px solid #00d9ff44;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1em;
        }
        
        button {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #00ff88, #00d9ff);
            color: #000;
            font-weight: bold;
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #ff4444, #ff6b6b);
            color: #fff;
            font-weight: bold;
        }
        
        button:hover { transform: scale(1.05); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .status-running { background: #00ff8833; color: #00ff88; border: 1px solid #00ff88; }
        .status-stopped { background: #ff444433; color: #ff4444; border: 1px solid #ff4444; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .stat-card {
            background: rgba(0, 217, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }
        
        .stat-card.alert {
            background: rgba(255, 68, 68, 0.1);
            border-color: rgba(255, 68, 68, 0.3);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #00d9ff;
        }
        
        .stat-card.alert .stat-value { color: #ff4444; }
        
        .stat-label {
            font-size: 0.9em;
            color: #888;
            margin-top: 5px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card-full {
            grid-column: span 2;
        }
        
        .card h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #00d9ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Historique simplifi√© - 1 ligne par minute */
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .history-table th {
            text-align: left;
            padding: 12px;
            background: rgba(0, 217, 255, 0.1);
            color: #00d9ff;
            font-weight: 600;
        }
        
        .history-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .history-table tbody tr {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-table tbody tr:hover {
            background: rgba(0, 217, 255, 0.1);
            transform: scale(1.01);
        }
        
        .history-table tr.malware {
            background: rgba(255, 68, 68, 0.1);
        }
        
        .history-table tr.malware:hover {
            background: rgba(255, 68, 68, 0.2);
        }
        
        .history-table tr.malware td {
            color: #ff6b6b;
        }
        
        .click-hint {
            font-size: 0.75em;
            color: #666;
            margin-left: 5px;
        }
        
        .app-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .app-badge.normal {
            background: rgba(0, 255, 136, 0.15);
            color: #00ff88;
        }
        
        .app-badge.malware {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        
        .confidence {
            font-size: 0.9em;
            padding: 3px 10px;
            border-radius: 12px;
        }
        
        .confidence.high {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .confidence.medium {
            background: rgba(255, 217, 61, 0.2);
            color: #ffd93d;
        }
        
        .confidence.low {
            background: rgba(255, 68, 68, 0.2);
            color: #ff6b6b;
        }
        
        .ip-text {
            font-family: 'Consolas', monospace;
            color: #888;
            font-size: 0.9em;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
        }
        
        .no-data {
            color: #666;
            text-align: center;
            padding: 60px 20px;
            font-style: italic;
        }
        
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-dot {
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .update-timer {
            text-align: center;
            padding: 10px;
            color: #666;
            font-size: 0.85em;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: 15px;
        }
        
        .history-scroll {
            max-height: 400px;
            overflow-y: auto;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        ::-webkit-scrollbar-thumb { background: #00d9ff44; border-radius: 4px; }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .card-full {
                grid-column: span 1;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Styles pour les lignes cliquables */
        .clickable-row {
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        .clickable-row:hover {
            background: rgba(0, 217, 255, 0.15) !important;
            transform: scale(1.005);
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: linear-gradient(145deg, #1a1a3e 0%, #0d0d1f 100%);
            border: 1px solid #00d9ff33;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 217, 255, 0.2);
        }

        /* ========== SECTION CONFIGURATION CLIENTS ========== */
        .config-section {
            max-width: 900px;
            margin: 30px auto;
            background: linear-gradient(145deg, rgba(15, 25, 45, 0.95) 0%, rgba(10, 18, 35, 0.98) 100%);
            border-radius: 20px;
            padding: 35px;
            border: 2px solid rgba(0, 217, 255, 0.25);
            box-shadow: 
                0 15px 50px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }
        .config-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00d9ff, #00ff88, #00d9ff);
        }
        .config-section h2 {
            margin: 0 0 30px 0;
            color: #fff;
            font-size: 1.5em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .config-grid {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        .config-field {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .config-field:first-child {
            flex: 0 0 180px;
        }
        .config-field:last-child {
            flex: 1;
        }
        .config-section label { 
            color: #00d9ff; 
            font-size: 0.95em; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .config-section input[type="number"] {
            width: 100%;
            padding: 16px 20px;
            border-radius: 12px;
            border: 2px solid rgba(0, 217, 255, 0.2);
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 1.5em;
            font-weight: 700;
            text-align: center;
            transition: all 0.3s ease;
        }
        .config-section input[type="number"]:hover {
            border-color: rgba(0, 217, 255, 0.4);
        }
        .config-section textarea {
            width: 100%;
            padding: 16px 18px;
            border-radius: 12px;
            border: 2px solid rgba(0, 217, 255, 0.2);
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 1.05em;
            resize: none;
            min-height: 70px;
            font-family: 'Consolas', 'Monaco', monospace;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        .config-section textarea::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }
        .config-section textarea:hover {
            border-color: rgba(0, 217, 255, 0.4);
        }
        .config-section input:focus, .config-section textarea:focus {
            outline: none;
            border-color: #00d9ff;
            box-shadow: 
                0 0 20px rgba(0, 217, 255, 0.25),
                inset 0 0 10px rgba(0, 217, 255, 0.05);
        }
        .client-ip-hint {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .config-actions {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            align-items: center;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00ff88 0%, #00d9ff 100%);
            border: none;
            padding: 15px 35px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1em;
            color: #000;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.5);
        }
        .btn-primary:active {
            transform: translateY(-1px);
        }
        .config-status { 
            color: #00ff88; 
            font-size: 0.95em;
            padding: 12px 20px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            display: none;
        }
        .config-status.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        .config-status.error {
            color: #ff6b6b;
            background: rgba(255, 68, 68, 0.1);
            border-color: rgba(255, 68, 68, 0.3);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== SECTION CLASSEMENT VOLUME ========== */
        .volume-ranking-section {
            max-width: 900px;
            margin: 30px auto;
            background: linear-gradient(145deg, rgba(15, 25, 45, 0.95) 0%, rgba(10, 18, 35, 0.98) 100%);
            border-radius: 20px;
            padding: 25px 30px;
            border: 2px solid rgba(255, 215, 0, 0.25);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }
        .volume-ranking-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ffd700, #ff8c00, #ffd700);
        }
        .volume-ranking-section h2 {
            margin: 0 0 20px 0;
            color: #ffd700;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ranking-total {
            font-size: 0.9em;
            color: #888;
            margin-left: auto;
            font-weight: normal;
        }
        .ranking-total-bandwidth {
            font-size: 0.85em;
            color: #00d9ff;
            margin-left: 15px;
            padding: 3px 10px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 5px;
        }
        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .ranking-item {
            display: grid;
            grid-template-columns: 50px 1fr 120px 120px 100px;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        .ranking-item:hover {
            background: rgba(255, 215, 0, 0.05);
            border-color: rgba(255, 215, 0, 0.2);
            transform: translateX(5px);
        }
        .ranking-item.rank-1 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), rgba(0, 0, 0, 0.3));
            border-color: rgba(255, 215, 0, 0.4);
        }
        .ranking-item.rank-2 {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.1), rgba(0, 0, 0, 0.3));
            border-color: rgba(192, 192, 192, 0.3);
        }
        .ranking-item.rank-3 {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.1), rgba(0, 0, 0, 0.3));
            border-color: rgba(205, 127, 50, 0.3);
        }
        .rank-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
        }
        .rank-1 .rank-badge {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #000;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }
        .rank-2 .rank-badge {
            background: linear-gradient(135deg, #c0c0c0, #a0a0a0);
            color: #000;
        }
        .rank-3 .rank-badge {
            background: linear-gradient(135deg, #cd7f32, #8b4513);
            color: #fff;
        }
        .rank-badge.default {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .ranking-ip {
            font-family: 'Consolas', monospace;
            font-size: 1.1em;
            color: #fff;
        }
        .ranking-volume {
            text-align: right;
        }
        .ranking-volume .value {
            font-size: 1.3em;
            font-weight: 700;
            color: #00d9ff;
        }
        .ranking-volume .unit {
            font-size: 0.85em;
            color: #888;
            margin-left: 3px;
        }
        .ranking-percent {
            text-align: center;
        }
        .ranking-percent .bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        .ranking-percent .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .ranking-percent .text {
            font-size: 0.85em;
            color: #888;
        }
        .ranking-bandwidth {
            text-align: center;
        }
        .ranking-bandwidth .value {
            font-size: 1.2em;
            font-weight: 700;
            color: #00ff88;
        }
        .ranking-bandwidth .unit {
            font-size: 0.75em;
            color: #888;
            margin-left: 2px;
        }
        .ranking-bandwidth .duration {
            font-size: 0.75em;
            color: #666;
            margin-top: 3px;
        }
        .no-ranking-data {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        /* ========== SECTION PANELS CLIENTS ========== */
        .client-panels-wrapper {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .client-panels-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .client-panels-header h2 {
            color: #00d9ff;
            font-size: 1.3em;
            margin: 0;
        }
        .client-count-badge {
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .client-panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
        }
        .client-panel {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.2) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 18px;
            padding: 20px;
            transition: all 0.3s;
        }
        .client-panel:hover {
            border-color: rgba(0, 217, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .panel-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .panel-header h3 {
            margin: 0;
            color: #fff;
            font-size: 1.2em;
            font-family: 'Consolas', monospace;
        }
        .panel-header p {
            margin: 5px 0 0 0;
            color: #888;
            font-size: 0.9em;
        }
        .panel-stats { 
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .panel-stat { 
            background: rgba(0, 217, 255, 0.08);
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
        }
        .panel-stat .label { 
            color: #888; 
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .panel-stat .value { 
            font-size: 1.5em; 
            font-weight: 700;
            color: #00d9ff;
            margin-top: 5px;
        }
        .mini-chart { 
            height: 140px; 
            margin-top: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 10px;
        }
        
        /* Mini historique par client */
        .client-history-section {
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
        }
        .client-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0, 217, 255, 0.1);
            border-bottom: 1px solid rgba(0, 217, 255, 0.2);
        }
        .client-history-header h4 {
            margin: 0;
            font-size: 0.9em;
            color: #00d9ff;
        }
        .client-history-scroll {
            max-height: 200px;
            overflow-y: auto;
        }
        .client-history-scroll::-webkit-scrollbar {
            width: 5px;
        }
        .client-history-scroll::-webkit-scrollbar-thumb {
            background: rgba(0, 217, 255, 0.3);
            border-radius: 3px;
        }
        .mini-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
        }
        .mini-history-table th {
            background: rgba(0, 0, 0, 0.3);
            color: #888;
            padding: 8px 10px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
        }
        .mini-history-table td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .mini-history-table .clickable-row {
            cursor: pointer;
            transition: background 0.2s;
        }
        .mini-history-table .clickable-row:hover {
            background: rgba(0, 217, 255, 0.1);
        }
        .mini-history-table .clickable-row.malware {
            background: rgba(255, 68, 68, 0.1);
        }
        .mini-history-table .clickable-row.malware:hover {
            background: rgba(255, 68, 68, 0.2);
        }
        .mini-app-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }
        .mini-app-badge.normal {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        .mini-app-badge.malware {
            background: rgba(255, 68, 68, 0.2);
            color: #ff6b6b;
        }
        .mini-confidence {
            font-weight: 600;
        }
        .mini-confidence.high { color: #00ff88; }
        .mini-confidence.medium { color: #ffd93d; }
        .mini-confidence.low { color: #ff6b6b; }
        
        .btn-secondary { 
            background: transparent;
            border: 1px solid #00d9ff;
            color: #00d9ff;
            border-radius: 8px;
            padding: 10px 18px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        .btn-secondary:hover {
            background: rgba(0, 217, 255, 0.1);
            transform: scale(1.02);
        }
        .no-clients-message {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 1.1em;
            background: rgba(255,255,255,0.02);
            border-radius: 15px;
            border: 2px dashed rgba(255,255,255,0.1);
        }
        .no-clients-message span {
            font-size: 3em;
            display: block;
            margin-bottom: 15px;
        }
            animation: modalSlide 0.3s ease;
        }
        @keyframes modalSlide {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #00d9ff33;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 217, 255, 0.05);
        }
        .modal-header h3 {
            margin: 0;
            color: #00d9ff;
            font-size: 1.3em;
        }
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s, transform 0.2s;
        }
        .modal-close:hover {
            color: #ff6b6b;
            transform: rotate(90deg);
        }
        .modal-body {
            padding: 20px 25px;
            overflow-y: auto;
            max-height: 60vh;
        }
        .modal-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .summary-item .value {
            font-size: 1.5em;
            font-weight: 600;
            color: #00d9ff;
        }
        .summary-item .label {
            color: #888;
            font-size: 0.85em;
            margin-top: 5px;
        }
        .flows-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .flow-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 120px 100px;
            align-items: center;
            gap: 15px;
            transition: border-color 0.2s;
        }
        .flow-item:hover {
            border-color: #00d9ff44;
        }
        .flow-item.malware {
            border-color: #ff6b6b44;
            background: rgba(255, 68, 68, 0.05);
        }
        .flow-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .flow-ips {
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
            color: #aaa;
        }
        .flow-ports {
            font-size: 0.8em;
            color: #666;
        }
        .flow-app {
            text-align: center;
        }
        .flow-confidence {
            text-align: right;
        }
        .no-flows {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }
    </style>
</head>
<body>
        <div class="header">
            <h1>üîç AI Application Tracker</h1>
            <p style="color: #888; margin-top: 5px;">Historique des applications d√©tect√©es par Intelligence Artificielle</p>
        
            <div class="controls">
                <div class="control-group">
                    <label style="color: #888;">Interface:</label>
                    <input type="text" id="interface" value="wlp3s0" placeholder="Interface r√©seau">
                </div>
                <button id="btnStart" class="btn-start" type="button">‚ñ∂Ô∏è D√©marrer</button>
                <button id="btnStop" class="btn-stop" type="button" disabled>‚èπÔ∏è Arr√™ter</button>
                <span id="statusBadge" class="status-badge status-stopped">‚ö´ Arr√™t√©</span>
            </div>
        </div>
    
        <section class="config-section">
            <h2>‚öôÔ∏è Configuration des Clients √† Surveiller</h2>
            <form id="clientConfigForm">
                <div class="config-grid">
                    <div class="config-field">
                        <label for="clientCount">üìä Nombre de clients</label>
                        <input type="number" id="clientCount" min="1" max="20" value="1">
                    </div>
                    <div class="config-field">
                        <label for="clientIps">üåê Adresses IP des clients</label>
                        <textarea id="clientIps" rows="2" placeholder="Ex: 192.168.1.10, 192.168.1.14, 10.0.0.5"></textarea>
                        <span class="client-ip-hint">üí° S√©parez les adresses IP par des virgules. Ex: 192.168.1.10, 192.168.1.20</span>
                    </div>
                </div>
                <div class="config-actions">
                    <button type="submit" class="btn-primary">‚úÖ Valider la Configuration</button>
                    <div id="configStatus" class="config-status"></div>
                </div>
            </form>
        </section>
    
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalFlows">0</div>
                <div class="stat-label">Flux Total Analys√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uniqueApps">0</div>
                <div class="stat-label">Applications D√©tect√©es</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalVolume">0 MB</div>
                <div class="stat-label">Volume Total</div>
            </div>
            <div class="stat-card alert">
                <div class="stat-value" id="malwareAlerts">0</div>
                <div class="stat-label">üö® Alertes Malware</div>
            </div>
        </div>

        <!-- Section Classement par Volume et Bande Passante -->
        <section class="volume-ranking-section" id="volumeRankingSection" style="display: none;">
            <h2>
                üèÜ Classement par Consommation & Bande Passante
                <span class="ranking-total" id="rankingTotal">Total: 0 MB</span>
                <span class="ranking-total-bandwidth" id="rankingTotalBandwidth">‚ö° 0 Mbps</span>
            </h2>
            <div class="ranking-list" id="rankingList">
                <div class="no-ranking-data">En attente de donn√©es...</div>
            </div>
        </section>
    
        <div class="client-panels-wrapper">
            <div class="client-panels-header">
                <h2>üñ•Ô∏è Surveillance par Client</h2>
                <span class="client-count-badge" id="clientCountBadge">0 clients configur√©s</span>
            </div>
            <div class="client-panels" id="clientPanels">
                <div class="no-clients-message" id="noClientMessage">
                    <span>üñ•Ô∏è</span>
                    Configurez des clients ci-dessus pour d√©marrer la surveillance.
                </div>
            </div>
        </div>
    
        <div class="main-content">
            <div class="card card-full">
                <h2>
                    <span class="live-indicator">
                        <span class="live-dot"></span>
                    </span>
                    üìú Historique Global (1 entr√©e / minute)
                </h2>
                <div class="history-scroll">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>‚è∞ Heure</th>
                                <th>üåê Destination IP</th>
                                <th>üì± Application</th>
                                <th>üìä Confiance</th>
                                <th>üìà Flux</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr>
                                <td colspan="5" class="no-data">
                                    En attente de donn√©es... (mise √† jour toutes les 60 secondes)
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="update-timer">
                    üîÑ Prochaine mise √† jour dans: <span id="countdown">60</span>s
                </div>
            </div>
        
            <div class="card">
                <h2>üìä R√©partition des Applications</h2>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        
            <div class="card">
                <h2>üìà √âvolution du Trafic</h2>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
    
    <!-- Modal pour les d√©tails des flux -->
    <div id="flowModal" class="modal-overlay" style="display: none;" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üìä D√©tails des flux - <span id="modalTime"></span></h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-summary">
                    <div class="summary-item">
                        <div class="value" id="modalTotalFlows">0</div>
                        <div class="label">Flux Total</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="modalMainApp">-</div>
                        <div class="label">App Dominante</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="modalAvgConf">0%</div>
                        <div class="label">Confiance Moyenne</div>
                    </div>
                </div>
                <h4 style="color: #00d9ff; margin-bottom: 15px;">üîç Liste des flux analys√©s:</h4>
                <div id="flowsList" class="flows-list">
                    <!-- Les flux seront inject√©s ici -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
    let ws;
    let pieChart, timelineChart;
    let historyData = [];
    let appsDistribution = {};
    let countdownValue = 60;
    let countdownInterval;
    let monitoredClients = [];
    let clientPanels = {};
    let clientHistory = {};
        
        // Initialiser les graphiques
        function initCharts() {
            // Pie Chart
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#00d9ff', '#00ff88', '#ff6b6b', '#ffd93d',
                            '#6bcb77', '#4d96ff', '#ff9f43', '#a55eea',
                            '#26de81', '#fd79a8', '#74b9ff', '#55efc4'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { 
                                color: '#fff', 
                                font: { size: 12 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} flux (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Timeline Chart
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Flux/minute',
                        data: [],
                        borderColor: '#00d9ff',
                        backgroundColor: '#00d9ff33',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#00d9ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#888' }, 
                            grid: { color: '#ffffff11' }
                        },
                        y: { 
                            ticks: { color: '#888' }, 
                            grid: { color: '#ffffff11' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // D√©marrer le countdown
        function startCountdown() {
            countdownValue = 60;
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                countdownValue--;
                document.getElementById('countdown').textContent = countdownValue;
                if (countdownValue <= 0) countdownValue = 60;
            }, 1000);
        }
        
        // Connexion WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onopen = () => {
                console.log('WebSocket connect√©');
                startCountdown();
            };
            
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                
                if (msg.type === 'init') {
                    historyData = msg.data.history || [];
                    appsDistribution = msg.data.apps_distribution || {};
                    monitoredClients = msg.data.clients || [];
                    clientHistory = msg.data.client_history || {};
                    const statsByClient = msg.data.client_stats || {};
                    renderClientPanels(monitoredClients, statsByClient, clientHistory);
                    updateStats(msg.data.stats);
                    updateHistoryTable();
                    updatePieChart();
                    updateStatus(msg.data.running);
                    // Afficher le classement si des clients sont configur√©s
                    if (monitoredClients.length > 0) {
                        document.getElementById('volumeRankingSection').style.display = 'block';
                        updateVolumeRanking();
                        // Mettre √† jour l'historique de chaque client
                        monitoredClients.forEach(ip => {
                            if (clientHistory[ip]) {
                                updateClientHistoryTable(ip, clientHistory[ip]);
                            }
                        });
                    }
                }
                else if (msg.type === 'minute_update') {
                    // Nouvelle entr√©e de minute re√ßue
                    historyData.push(msg.data.record);
                    if (historyData.length > 60) historyData.shift();
                    
                    appsDistribution = msg.data.apps_distribution;
                    updateStats(msg.data.stats);
                    updateHistoryTable();
                    updatePieChart();
                    updateTimelineChart();
                    
                    // Reset countdown
                    countdownValue = 60;
                }
                else if (msg.type === 'client_update') {
                    const clientIp = msg.client;
                    if (!clientHistory[clientIp]) clientHistory[clientIp] = [];
                    clientHistory[clientIp].push(msg.data.record);
                    if (clientHistory[clientIp].length > 60) {
                        clientHistory[clientIp] = clientHistory[clientIp].slice(-60);
                    }
                    updateClientPanel(clientIp, msg.data.stats, msg.data.record);
                    // Mise √† jour de l'historique mini du client
                    updateClientHistoryTable(clientIp, clientHistory[clientIp]);
                    // Mise √† jour du classement
                    updateVolumeRanking();
                }
                else if (msg.type === 'clients_update') {
                    monitoredClients = msg.clients || [];
                    renderClientPanels(monitoredClients, {}, {});
                    // Afficher/masquer la section classement
                    document.getElementById('volumeRankingSection').style.display = 
                        monitoredClients.length > 0 ? 'block' : 'none';
                    if (monitoredClients.length > 0) updateVolumeRanking();
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket ferm√©, reconnexion...');
                setTimeout(connectWebSocket, 3000);
            };
        }
        
        // D√©marrer le sniffer
        async function startSniffer() {
            console.log('startSniffer appel√©');
            const iface = document.getElementById('interface').value;
            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');
            
            // D√©sactiver le bouton pendant la requ√™te
            btnStart.disabled = true;
            btnStart.textContent = '‚è≥ D√©marrage...';
            
            try {
                const resp = await fetch('/api/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `interface=${iface}`
                });
                const data = await resp.json();
                console.log('R√©ponse:', data);
                
                if (data.success) {
                    updateStatus(true);
                } else {
                    alert('Erreur: ' + data.error);
                    btnStart.disabled = false;
                    btnStart.textContent = '‚ñ∂Ô∏è D√©marrer';
                }
            } catch (error) {
                console.error('Erreur fetch:', error);
                alert('Erreur de connexion au serveur: ' + error.message);
                btnStart.disabled = false;
                btnStart.textContent = '‚ñ∂Ô∏è D√©marrer';
            }
        }
        
        // Arr√™ter le sniffer
        async function stopSniffer() {
            await fetch('/api/stop', { method: 'POST' });
            updateStatus(false);
        }
        
        // Mettre √† jour le statut
        function updateStatus(running) {
            const badge = document.getElementById('statusBadge');
            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');
            
            if (running) {
                badge.className = 'status-badge status-running';
                badge.textContent = 'üü¢ En cours...';
                btnStart.disabled = true;
                btnStop.disabled = false;
            } else {
                badge.className = 'status-badge status-stopped';
                badge.textContent = '‚ö´ Arr√™t√©';
                btnStart.disabled = false;
                btnStop.disabled = true;
            }
        }
        
        // Mettre √† jour les stats
        function updateStats(stats) {
            document.getElementById('totalFlows').textContent = stats.total_flows || 0;
            document.getElementById('totalVolume').textContent = (stats.volume_mb || stats.total_volume_mb || 0) + ' MB';
            document.getElementById('malwareAlerts').textContent = stats.malware_alerts || 0;
            document.getElementById('uniqueApps').textContent = Object.keys(appsDistribution).length;
        }
        
        // Mettre √† jour le tableau d'historique (1 ligne par minute)
        function updateHistoryTable() {
            const tbody = document.getElementById('historyBody');
            
            if (historyData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data">
                            En attente de donn√©es... (mise √† jour toutes les 60 secondes)
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Afficher du plus r√©cent au plus ancien
            const reversed = [...historyData].reverse();
            
            tbody.innerHTML = reversed.map(item => {
                const isMalware = item.is_malware;
                const confidence = item.confidence || 0;
                
                // D√©terminer le niveau de confiance
                let confLevel = 'low';
                if (confidence >= 70) confLevel = 'high';
                else if (confidence >= 50) confLevel = 'medium';
                
                return `
                    <tr class="clickable-row ${isMalware ? 'malware' : ''}" onclick="showFlowDetails('${item.time}')" title="Cliquez pour voir les d√©tails">
                        <td><strong>${item.time}</strong></td>
                        <td class="ip-text">${item.dest_ip}</td>
                        <td>
                            <span class="app-badge ${isMalware ? 'malware' : 'normal'}">
                                ${isMalware ? 'ü¶†' : 'üì±'} ${item.app}
                            </span>
                        </td>
                        <td>
                            <span class="confidence ${confLevel}">${confidence}%</span>
                        </td>
                        <td>${item.total_flows} flux üîç</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Afficher les d√©tails des flux dans le modal
        async function showFlowDetails(time) {
            const modal = document.getElementById('flowModal');
            const flowsList = document.getElementById('flowsList');
            
            // Afficher le modal avec √©tat de chargement
            modal.style.display = 'flex';
            document.getElementById('modalTime').textContent = time;
            flowsList.innerHTML = '<div class="no-flows">‚è≥ Chargement des flux...</div>';
            
            try {
                // R√©cup√©rer les d√©tails via l'API
                const response = await fetch(`/api/minute-details/${encodeURIComponent(time)}`);
                const data = await response.json();
                
                if (!data.success) {
                    flowsList.innerHTML = '<div class="no-flows">‚ùå Donn√©es non disponibles</div>';
                    return;
                }
                
                // Mettre √† jour le r√©sum√©
                document.getElementById('modalTotalFlows').textContent = data.total_flows;
                document.getElementById('modalMainApp').textContent = data.dominant_app;
                document.getElementById('modalAvgConf').textContent = data.average_confidence + '%';
                
                // Afficher les flux
                if (!data.flows || data.flows.length === 0) {
                    flowsList.innerHTML = '<div class="no-flows">Aucun flux d√©taill√© disponible</div>';
                    return;
                }
                
                flowsList.innerHTML = data.flows.map((flow, index) => {
                    // Utiliser flow.label ou flow.app en fallback
                    const appName = flow.label || flow.app || 'Inconnu';
                    const isMalware = ['ZEUS', 'TINBA', 'MIUREF', 'NERIS', 'NSIS', 'VIRUT'].includes(appName.toUpperCase());
                    let confLevel = 'low';
                    if (flow.confidence >= 70) confLevel = 'high';
                    else if (flow.confidence >= 50) confLevel = 'medium';
                    
                    return `
                        <div class="flow-item ${isMalware ? 'malware' : ''}">
                            <div class="flow-info">
                                <div class="flow-ips">
                                    üì§ ${flow.src_ip || 'N/A'} ‚Üí üì• ${flow.dest_ip || 'N/A'}
                                </div>
                                <div class="flow-ports">
                                    Port: ${flow.dest_port || 'N/A'} | Protocole: ${flow.protocol || 'N/A'} | 
                                    ${flow.packets || 0} paquets | ${((flow.bytes || flow.volume || 0) / 1024).toFixed(2)} KB
                                </div>
                            </div>
                            <div class="flow-app">
                                <span class="app-badge ${isMalware ? 'malware' : 'normal'}">
                                    ${isMalware ? 'ü¶†' : 'üì±'} ${appName}
                                </span>
                            </div>
                            <div class="flow-confidence">
                                <span class="confidence ${confLevel}">${flow.confidence || 0}%</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des d√©tails:', error);
                flowsList.innerHTML = '<div class="no-flows">‚ùå Erreur de connexion</div>';
            }
        }
        
        // Fermer le modal
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('flowModal').style.display = 'none';
        }
        
        // Fermer avec Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
        
        // Mettre √† jour le Pie Chart
        function updatePieChart() {
            if (!appsDistribution || Object.keys(appsDistribution).length === 0) return;
            
            // Trier par nombre de flux d√©croissant
            const sorted = Object.entries(appsDistribution)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);  // Top 10
            
            pieChart.data.labels = sorted.map(([name]) => name);
            pieChart.data.datasets[0].data = sorted.map(([, count]) => count);
            pieChart.update();
        }
        
        // Mettre √† jour le Timeline Chart
        function updateTimelineChart() {
            if (historyData.length === 0) return;
            
            // Utiliser les donn√©es d'historique pour le timeline
            const recent = historyData.slice(-20);
            
            timelineChart.data.labels = recent.map(item => item.time);
            timelineChart.data.datasets[0].data = recent.map(item => item.total_flows);
            timelineChart.update();
        }
        
        // Rafra√Æchir les donn√©es depuis l'API
        async function refreshData() {
            try {
                const [statsResp, historyResp] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/history')
                ]);
                
                const stats = await statsResp.json();
                const history = await historyResp.json();
                
                appsDistribution = stats.flows_by_type || {};
                historyData = history.history || [];
                
                document.getElementById('totalFlows').textContent = stats.total_flows;
                document.getElementById('totalVolume').textContent = stats.total_volume_mb + ' MB';
                document.getElementById('malwareAlerts').textContent = stats.malware_alerts;
                document.getElementById('uniqueApps').textContent = Object.keys(appsDistribution).length;
                
                updateHistoryTable();
                updatePieChart();
                updateTimelineChart();
                
            } catch (error) {
                console.error('Erreur refresh:', error);
            }
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            connectWebSocket();
            refreshData();
            
            // Attacher les √©v√©nements aux boutons
            document.getElementById('btnStart').addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Bouton D√©marrer cliqu√©');
                startSniffer();
            });
            
            document.getElementById('btnStop').addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Bouton Arr√™ter cliqu√©');
                stopSniffer();
            });

            document.getElementById('clientConfigForm').addEventListener('submit', configureClients);
            
            // Mise √† jour p√©riodique du classement
            setInterval(updateVolumeRanking, 5000);
        });

        async function configureClients(event) {
            event.preventDefault();
            const ipsInput = document.getElementById('clientIps').value;
            const ips = ipsInput.split(',').map(ip => ip.trim()).filter(Boolean);
            const statusBox = document.getElementById('configStatus');
            
            statusBox.className = 'config-status visible';
            statusBox.textContent = '‚è≥ Envoi de la configuration...';
            
            try {
                const resp = await fetch('/api/configure-clients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clients: ips })
                });
                const data = await resp.json();
                if (data.success) {
                    statusBox.className = 'config-status visible';
                    statusBox.textContent = `‚úÖ ${data.clients.length} client(s) configur√©(s): ${data.clients.join(', ')}`;
                    monitoredClients = data.clients;
                    renderClientPanels(monitoredClients, {}, {});
                    // Afficher la section de classement
                    document.getElementById('volumeRankingSection').style.display = 'block';
                    updateVolumeRanking();
                } else {
                    statusBox.className = 'config-status visible error';
                    statusBox.textContent = '‚ùå Erreur de configuration';
                }
            } catch (err) {
                statusBox.className = 'config-status visible error';
                statusBox.textContent = '‚ùå Erreur r√©seau: ' + err.message;
            }
        }

        async function updateVolumeRanking() {
            if (monitoredClients.length === 0) return;
            
            try {
                const resp = await fetch('/api/clients/ranking');
                const data = await resp.json();
                renderVolumeRanking(data);
            } catch (err) {
                console.error('Erreur mise √† jour classement:', err);
            }
        }

        function formatVolume(bytes) {
            if (bytes >= 1024 * 1024 * 1024) {
                return { value: (bytes / (1024 * 1024 * 1024)).toFixed(2), unit: 'GB' };
            } else if (bytes >= 1024 * 1024) {
                return { value: (bytes / (1024 * 1024)).toFixed(2), unit: 'MB' };
            } else if (bytes >= 1024) {
                return { value: (bytes / 1024).toFixed(2), unit: 'KB' };
            } else {
                return { value: bytes, unit: 'B' };
            }
        }

        function formatBandwidth(mbps) {
            if (mbps >= 1000) {
                return { value: (mbps / 1000).toFixed(2), unit: 'Gbps' };
            } else if (mbps >= 1) {
                return { value: mbps.toFixed(2), unit: 'Mbps' };
            } else {
                return { value: (mbps * 1000).toFixed(1), unit: 'Kbps' };
            }
        }

        function renderVolumeRanking(data) {
            const container = document.getElementById('rankingList');
            const totalSpan = document.getElementById('rankingTotal');
            const totalBandwidthSpan = document.getElementById('rankingTotalBandwidth');
            const section = document.getElementById('volumeRankingSection');
            
            if (!data.ranking || data.ranking.length === 0) {
                container.innerHTML = '<div class="no-ranking-data">En attente de donn√©es...</div>';
                return;
            }
            
            section.style.display = 'block';
            
            // Mise √† jour du total volume
            const totalFormatted = formatVolume(data.total_volume_mb * 1024 * 1024);
            totalSpan.textContent = `Total: ${totalFormatted.value} ${totalFormatted.unit}`;
            
            // Mise √† jour du total bande passante
            if (totalBandwidthSpan) {
                const totalBw = formatBandwidth(data.total_bandwidth_mbps || 0);
                totalBandwidthSpan.textContent = `‚ö° ${totalBw.value} ${totalBw.unit}`;
            }
            
            // G√©n√©ration du classement avec d√©bit
            container.innerHTML = data.ranking.map(client => {
                const vol = formatVolume(client.volume_bytes);
                const bw = formatBandwidth(client.bandwidth_mbps || 0);
                const rankClass = client.rank <= 3 ? `rank-${client.rank}` : '';
                const badgeClass = client.rank <= 3 ? '' : 'default';
                const medal = client.rank === 1 ? 'ü•á' : client.rank === 2 ? 'ü•à' : client.rank === 3 ? 'ü•â' : client.rank;
                const duration = client.session_duration_formatted || '0s';
                
                return `
                    <div class="ranking-item ${rankClass}">
                        <div class="rank-badge ${badgeClass}">${medal}</div>
                        <div class="ranking-ip">${client.ip}</div>
                        <div class="ranking-volume">
                            <span class="value">${vol.value}</span>
                            <span class="unit">${vol.unit}</span>
                        </div>
                        <div class="ranking-bandwidth">
                            <span class="value">${bw.value}</span>
                            <span class="unit">${bw.unit}</span>
                            <div class="duration">‚è±Ô∏è ${duration}</div>
                        </div>
                        <div class="ranking-percent">
                            <div class="bar">
                                <div class="bar-fill" style="width: ${client.percentage}%"></div>
                            </div>
                            <span class="text">${client.percentage}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderClientPanels(clients, statsByClient, historyByClient) {
            const container = document.getElementById('clientPanels');
            const countBadge = document.getElementById('clientCountBadge');
            container.innerHTML = '';
            
            // Mise √† jour du badge de comptage
            if (countBadge) {
                countBadge.textContent = clients && clients.length > 0 
                    ? `${clients.length} client${clients.length > 1 ? 's' : ''} configur√©${clients.length > 1 ? 's' : ''}`
                    : '0 clients configur√©s';
            }
            
            if (!clients || clients.length === 0) {
                container.innerHTML = `
                    <div class="no-clients-message" id="noClientMessage">
                        <span>üñ•Ô∏è</span>
                        Configurez des clients ci-dessus pour d√©marrer la surveillance.
                    </div>`;
                return;
            }
            
            clients.forEach(ip => {
                const panel = document.createElement('div');
                panel.className = 'client-panel';
                panel.id = `client-panel-${ip.replace(/\./g, '-')}`;
                const safeIp = ip.replace(/\./g, '-');
                panel.innerHTML = `
                    <div class="panel-header">
                        <div>
                            <h3>üñ•Ô∏è ${ip}</h3>
                            <p id="client-main-app-${ip}">App dominante: En attente...</p>
                        </div>
                        <button class="btn-secondary" onclick="openClientModal('${ip}')">üìä D√©tails</button>
                    </div>
                    <div class="panel-stats">
                        <div class="panel-stat">
                            <div class="label">Flux</div>
                            <div class="value" id="client-flows-${ip}">0</div>
                        </div>
                        <div class="panel-stat">
                            <div class="label">Volume</div>
                            <div class="value" id="client-volume-${ip}">0 KB</div>
                        </div>
                        <div class="panel-stat">
                            <div class="label">Confiance</div>
                            <div class="value" id="client-confidence-${ip}">0%</div>
                        </div>
                    </div>
                    <div class="mini-chart">
                        <canvas id="client-chart-${ip}"></canvas>
                    </div>
                    <div class="client-history-section">
                        <div class="client-history-header">
                            <h4>üìú Historique (1 entr√©e/min)</h4>
                        </div>
                        <div class="client-history-scroll">
                            <table class="mini-history-table">
                                <thead>
                                    <tr>
                                        <th>‚è∞</th>
                                        <th>üì± App</th>
                                        <th>üìä</th>
                                        <th>üìà</th>
                                    </tr>
                                </thead>
                                <tbody id="client-history-body-${safeIp}">
                                    <tr><td colspan="4" style="text-align:center;color:#666;padding:20px;">En attente...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.appendChild(panel);
                // Initialiser l'historique si disponible
                if (historyByClient[ip] && historyByClient[ip].length > 0) {
                    updateClientHistoryTable(ip, historyByClient[ip]);
                }
                updateClientPanel(ip, statsByClient[ip], historyByClient[ip] ? historyByClient[ip].slice(-1)[0] : null);
            });
        }

        const clientCharts = {};

        // Fonction pour mettre √† jour l'historique d'un client
        function updateClientHistoryTable(ip, history) {
            const safeIp = ip.replace(/\./g, '-');
            const tbody = document.getElementById(`client-history-body-${safeIp}`);
            if (!tbody) return;
            
            if (!history || history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#666;padding:20px;">En attente...</td></tr>';
                return;
            }
            
            const MALWARE_APPS = ['ZEUS', 'TINBA', 'MIUREF', 'NERIS', 'NSIS', 'VIRUT'];
            
            // Afficher les 10 derni√®res entr√©es (plus r√©centes en haut)
            const recentHistory = history.slice(-10).reverse();
            
            tbody.innerHTML = recentHistory.map(record => {
                const app = record.app || 'UNKNOWN';
                const isMalware = MALWARE_APPS.includes(app.toUpperCase());
                const confidence = record.confidence || 0;
                const confClass = confidence >= 70 ? 'high' : confidence >= 50 ? 'medium' : 'low';
                const flowCount = record.flow_count || record.flows || 0;
                
                return `
                    <tr class="clickable-row ${isMalware ? 'malware' : ''}" 
                        onclick="showClientFlowDetails('${ip}', '${record.time}')" 
                        title="Cliquez pour voir les d√©tails">
                        <td><strong>${record.time}</strong></td>
                        <td>
                            <span class="mini-app-badge ${isMalware ? 'malware' : 'normal'}">
                                ${isMalware ? 'ü¶†' : 'üì±'} ${app}
                            </span>
                        </td>
                        <td><span class="mini-confidence ${confClass}">${confidence.toFixed(1)}%</span></td>
                        <td>${flowCount} üîç</td>
                    </tr>
                `;
            }).join('');
        }

        // Fonction pour afficher les d√©tails d'un flux client
        async function showClientFlowDetails(ip, minute) {
            const modal = document.getElementById('flowModal');
            modal.style.display = 'flex';
            document.getElementById('modalTime').textContent = `${ip} - ${minute}`;
            document.getElementById('flowsList').innerHTML = '<div class="no-flows">Chargement...</div>';
            
            try {
                const resp = await fetch(`/api/client/${ip}/flows/${minute}`);
                const data = await resp.json();
                renderFlowList(data.flows || []);
            } catch (err) {
                document.getElementById('flowsList').innerHTML = `<div class="no-flows">Erreur: ${err.message}</div>`;
            }
        }

        function updateClientPanel(ip, stats, latestRecord) {
            if (!stats) return;
            const flowsEl = document.getElementById(`client-flows-${ip}`);
            const volumeEl = document.getElementById(`client-volume-${ip}`);
            const confidenceEl = document.getElementById(`client-confidence-${ip}`);
            const mainAppEl = document.getElementById(`client-main-app-${ip}`);
            if (flowsEl) flowsEl.textContent = stats.total_flows || 0;
            if (volumeEl) volumeEl.textContent = (stats.volume_mb || 0) + ' MB';
            if (confidenceEl) confidenceEl.textContent = (stats.average_confidence || 0) + '%';
            if (mainAppEl && latestRecord) mainAppEl.textContent = `App dominante: ${latestRecord.app}`;

            const chartId = `client-chart-${ip}`;
            const ctx = document.getElementById(chartId);
            if (!ctx) return;
            if (!clientCharts[ip]) {
                clientCharts[ip] = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: ['#00d9ff', '#00ff88', '#ff6b6b', '#ffd93d'] }] },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
            }
            const chart = clientCharts[ip];
            const labels = (stats.top_apps || []).map(a => a.label);
            const data = (stats.top_apps || []).map(a => a.count);
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        }

        async function openClientModal(ip) {
            const modal = document.getElementById('flowModal');
            modal.style.display = 'flex';
            document.getElementById('modalTime').textContent = ip;
            document.getElementById('flowsList').innerHTML = '<div class="no-flows">Chargement...</div>';
            try {
                const statsResp = await fetch(`/api/client/${ip}/stats`);
                const statsData = await statsResp.json();
                const latest = statsData.latest_record;
                const flows = latest ? latest.flows_detail : [];
                document.getElementById('modalTotalFlows').textContent = latest ? latest.total_flows : 0;
                document.getElementById('modalMainApp').textContent = latest ? latest.app : '-';
                document.getElementById('modalAvgConf').textContent = statsData.stats.average_confidence + '%';
                renderFlowList(flows);
            } catch (err) {
                document.getElementById('flowsList').innerHTML = '<div class="no-flows">Erreur de chargement</div>';
            }
        }

        function renderFlowList(flows) {
            const container = document.getElementById('flowsList');
            if (!flows || flows.length === 0) {
                container.innerHTML = '<div class="no-flows">Aucun flux d√©taill√© disponible</div>';
                return;
            }
            container.innerHTML = flows.map(flow => {
                // Utiliser flow.label (du backend) ou flow.app en fallback
                const appName = flow.label || flow.app || 'Inconnu';
                const isMalware = ['ZEUS', 'TINBA', 'MIUREF', 'NERIS', 'NSIS', 'VIRUT'].includes(appName.toUpperCase());
                let confLevel = 'low';
                if (flow.confidence >= 70) confLevel = 'high';
                else if (flow.confidence >= 50) confLevel = 'medium';
                return `
                    <div class="flow-item ${isMalware ? 'malware' : ''}">
                        <div class="flow-info">
                            <div class="flow-ips">üì§ ${flow.src_ip || 'N/A'} ‚Üí üì• ${flow.dest_ip || 'N/A'}</div>
                            <div class="flow-ports">Port: ${flow.dest_port || 0} | ${flow.protocol || 'TCP'} | ${((flow.volume || 0) / 1024).toFixed(2)} KB | ${flow.packets || 0} paquets</div>
                        </div>
                        <div class="flow-app"><span class="app-badge ${isMalware ? 'malware' : 'normal'}">${appName}</span></div>
                        <div class="flow-confidence"><span class="confidence ${confLevel}">${flow.confidence || 0}%</span></div>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>
